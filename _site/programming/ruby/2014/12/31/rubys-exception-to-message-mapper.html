<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Ruby’s exception to message mapper | Kyrylo Silin</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="Ruby’s exception to message mapper" />
<meta name="author" content="Kyrylo Silin" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Exception to message mapper is a Ruby library bundled with the standard Ruby library distribution since Ruby 1.1 (released in the 20th century). It was written by Keiju ISHITSUKA and apparently meant to be used internally, to simplify Ruby’s stdlib source code. But since it’s available in the stdlib, it’s also available for us. You may be wondering what this library is about. Well, guess what?.. It maps messages to exceptions!" />
<meta property="og:description" content="Exception to message mapper is a Ruby library bundled with the standard Ruby library distribution since Ruby 1.1 (released in the 20th century). It was written by Keiju ISHITSUKA and apparently meant to be used internally, to simplify Ruby’s stdlib source code. But since it’s available in the stdlib, it’s also available for us. You may be wondering what this library is about. Well, guess what?.. It maps messages to exceptions!" />
<link rel="canonical" href="https://kyrylo.org/programming/ruby/2014/12/31/rubys-exception-to-message-mapper.html" />
<meta property="og:url" content="https://kyrylo.org/programming/ruby/2014/12/31/rubys-exception-to-message-mapper.html" />
<meta property="og:site_name" content="Kyrylo Silin" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-12-31T00:23:44+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Ruby’s exception to message mapper" />
<meta name="twitter:site" content="@kyrylosilin" />
<meta name="twitter:creator" content="@Kyrylo Silin" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Kyrylo Silin","url":"https://kyrylo.org/"},"dateModified":"2024-06-10T09:55:11+03:00","datePublished":"2014-12-31T00:23:44+02:00","description":"Exception to message mapper is a Ruby library bundled with the standard Ruby library distribution since Ruby 1.1 (released in the 20th century). It was written by Keiju ISHITSUKA and apparently meant to be used internally, to simplify Ruby’s stdlib source code. But since it’s available in the stdlib, it’s also available for us. You may be wondering what this library is about. Well, guess what?.. It maps messages to exceptions!","headline":"Ruby’s exception to message mapper","mainEntityOfPage":{"@type":"WebPage","@id":"https://kyrylo.org/programming/ruby/2014/12/31/rubys-exception-to-message-mapper.html"},"url":"https://kyrylo.org/programming/ruby/2014/12/31/rubys-exception-to-message-mapper.html"}</script>
<!-- End Jekyll SEO tag -->
<link type="application/atom+xml" rel="alternate" href="https://kyrylo.org/feed.xml" title="Kyrylo Silin" /><link rel="icon" type="image/png" href="/assets/images/favicon-96x96.png" sizes="96x96" />
  <link rel="shortcut icon" href="/assets/images/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/apple-touch-icon.png" />
  <meta name="apple-mobile-web-app-title" content="Kyrylo Silin" />
  <link rel="manifest" href="/assets/images/site.webmanifest" />

  <script defer data-domain="kyrylo.org" src="https://plausible.telebugs.com/js/script.hash.outbound-links.tagged-events.js"></script>
  <script>window.plausible = window.plausible || function () { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>
  <script data-site="KDDVSIV" src="https://analytics.kyrylo.org/script.js" defer></script>

  <style>
    body {
      font: 16px "Lucida Grande", "Lucida Sans Unicode", Arial, Helvetica, Verdana, sans-serif;
      line-height: 1.5;
    }

    main,
    footer {
      max-width: 70ch;
      margin: 0 auto;
    }

    pre {
      overflow: auto;
    }

    pre,
    blockquote {
      background-color: ghostwhite;
      color: darkslategray;
    }

    .article img {
      max-width: 100%;
    }

    .article a,
    code {
      word-break: break-word;
    }

    code {
      font-size: 14px;
    }

    blockquote {
      margin: 1em 0;
      padding-left: 20px;
      border-left: 4px solid dimgray;
    }

    nav a {
      margin-right: 8px;
    }

    a {
      color: blue;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    a:visited:active,
    a:active {
      color: red;
    }

    a:visited {
      color: purple;
    }

    ul.blog-posts {
      list-style-type: none;
      padding: unset;
      margin: 0;
    }

    ul.blog-posts li {
      display: flex;
    }

    ul.blog-posts li span {
      flex: 0 0 13ch;
    }

    ul.blog-posts time {
      font-family: monospace;
    }

    @media (prefers-color-scheme: dark) {
      a {
        color: mediumslateblue;
      }

      a:visited:active,
      a:active {
        color: orangered;
      }

      a:visited {
        color: plum;
      }

      pre,
      blockquote {
        color: lightsteelblue;
        background-color: #2b2b2b;
      }
    }
  </style>
</head>
<body>
    <main>
      <article itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    <h1 itemprop="name headline">Ruby&#39;s exception to message mapper</h1>

    <p>
      <time datetime="2014-12-31T00:23:44+02:00" itemprop="datePublished">
        Dec 31, 2014
      </time>
      |
      <span itemprop="author" itemscope itemtype="http://schema.org/Person">
        <picture>
          <source srcset="/assets/images/kyrylo-silin.webp 2x, /assets/images/kyrylo-silin.webp 1x" type="image/webp">
          <img src="/assets/images/kyrylo-silin.webp" alt="Kyrylo Silin" width="15" height="15">
        </picture>
        <span itemprop="name">
          <a href="/">Kyrylo Silin</a>
        </span>
      </span>
      &middot;
      <a href="https://x.com/kyrylo" target="_blank">@kyrylo</a>
      &middot;
      <a href="https://bsky.app/profile/kyrylo.org" target="_blank">bluesky:@kyrylo.org</a>
      &middot;
      <a href="https://mastodon.social/@kyrylosilin" target="_blank">mastodon:@kyrylosilin</a>
    </p>
  </header>

  <div class="article" itemprop="articleBody">
    <p>Exception to message mapper is a Ruby library bundled with the standard Ruby
library distribution since Ruby 1.1 (released in the 20th century). It was
written by Keiju ISHITSUKA and apparently meant to be used internally, to
simplify Ruby’s stdlib source code. But since it’s available in the stdlib, it’s
also available for us. You may be wondering what this library is about. Well,
guess what?.. It maps messages to exceptions!</p>

<h2 id="why-would-you-use-it">Why would you use it</h2>

<p>Probably you won’t use it anyway (and I understand why), but let’s imagine a
somewhat far-fetched example. When you define a custom exception it usually
doesn’t have any context. For example, <code class="language-plaintext highlighter-rouge">ArgumentError</code> doesn’t tell a lot on its
own. If you want to use the exception (that is, you <code class="language-plaintext highlighter-rouge">raise</code> it), you usually
write an accompanying message that explains why this exception is being raised.
By doing this you connect the explanation to the exception, which forms 1
logical unit. If your class often raises the same (or almost the same
exception), if the exception messages are long, they may clutter the code,
because you constantly “connect” explanations. Ever had such problems? It makes
sense to refactor the messy code. An exception to message mapper comes to the
rescue.</p>

<p>Say you have <code class="language-plaintext highlighter-rouge">Validator</code>, the ultimate validator class of the new generation
that validates everyone and everything. It’s simple, but not simple-minded. The
validator dislikes and rejects integer <code class="language-plaintext highlighter-rouge">0</code>, string <code class="language-plaintext highlighter-rouge">"password"</code> and sneaky SQL
queries like <code class="language-plaintext highlighter-rouge">"SELECT * FROM users;"</code>. If it sees something like that, it whines
and raises an exception. Otherwise it returns <code class="language-plaintext highlighter-rouge">true</code>.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Validator</span>
  <span class="k">class</span> <span class="nc">ValidatorError</span> <span class="o">&lt;</span> <span class="no">ArgumentError</span><span class="p">;</span> <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">validate</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
     <span class="k">case</span> <span class="n">datum</span>
     <span class="k">when</span> <span class="mi">0</span>
        <span class="k">raise</span> <span class="no">ValidatorError</span><span class="p">,</span> <span class="s2">"meh, no-one uses zeros in 2014"</span>
     <span class="k">when</span> <span class="s2">"password"</span>
       <span class="k">if</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">year</span> <span class="o">==</span> <span class="mi">2015</span>
         <span class="k">raise</span> <span class="no">ValidatorError</span><span class="p">,</span> <span class="s2">"meh, no-one uses passwords in 2015"</span>
       <span class="k">else</span>
         <span class="kp">true</span>
       <span class="k">end</span>
     <span class="k">when</span> <span class="sr">/SELECT \* FROM .+;/i</span>
       <span class="k">raise</span> <span class="no">ValidatorError</span><span class="p">,</span> <span class="s2">"cheating is not allowed"</span>
     <span class="k">else</span>
       <span class="kp">true</span>
     <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>As you can see there’s a problem with this class: it raises the same exception
with almost the same exception message. Let’s solve the problem by mapping a
predefined message to <code class="language-plaintext highlighter-rouge">Validator::ValidatorError</code> to remove duplication. No need
to reinvent the wheel, we have a handy tool in our tool belt.</p>

<h2 id="example-usage">Example usage</h2>

<p>The <code class="language-plaintext highlighter-rouge">e2mmap</code> library implements an exception to message mapper. Behind the
scenes the implementation uses really <a href="https://github.com/ruby/ruby/blob/2afed6eceff2951b949db7ded8167a75b431bad6/lib/e2mmap.rb">old school Ruby</a> with <code class="language-plaintext highlighter-rouge">for</code> loops
and whistles but that’s none of our concern. Firstly, require <code class="language-plaintext highlighter-rouge">e2mmap</code>, which
defines the <code class="language-plaintext highlighter-rouge">Exception2MessageMapper</code> class.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'e2mmap'</span> <span class="c1"># From stdlib.</span>
</code></pre></div></div>

<p>Next, let’s define a separate module that maps messages to exceptions. It’s
worth mentioning that you can bake this straight into the <code class="language-plaintext highlighter-rouge">Validator</code>’s body.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Validator</span>
  <span class="k">module</span> <span class="nn">ExceptionsForValidator</span>
    <span class="kp">extend</span> <span class="no">Exception2MessageMapper</span>
    <span class="n">def_exception</span> <span class="ss">:ValidatorError</span><span class="p">,</span> <span class="s2">"meh, no-one uses %s in %s"</span><span class="p">,</span> <span class="no">ArgumentError</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Here we extended <code class="language-plaintext highlighter-rouge">ExceptionsForValidator</code> with <code class="language-plaintext highlighter-rouge">e2mmap</code> and defined a new
exception class (<code class="language-plaintext highlighter-rouge">ValidatorError</code>) with a message attached to it. The message is
<code class="language-plaintext highlighter-rouge">"meh, no-one uses %s in %s"</code>. The <code class="language-plaintext highlighter-rouge">ArgumentError</code> argument is the superclass of
<code class="language-plaintext highlighter-rouge">ValidatorError</code>.</p>

<p>Now we can use the module in the <code class="language-plaintext highlighter-rouge">Validator</code> class. We also need to change the
implementation of the <code class="language-plaintext highlighter-rouge">.validate</code> method slightly. In places where we want to
reuse our exception message <code class="language-plaintext highlighter-rouge">raise</code> becomes <code class="language-plaintext highlighter-rouge">Raise</code>. <code class="language-plaintext highlighter-rouge">Raise</code> is just a method
defined on <code class="language-plaintext highlighter-rouge">self</code>. It accepts the next arguments: an error class to be raised,
the arguments to substitute for <code class="language-plaintext highlighter-rouge">%s</code>’s in the message.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Validator</span>
  <span class="kp">include</span> <span class="no">ValidatorErrors</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">validate</span><span class="p">(</span><span class="n">datum</span><span class="p">)</span>
     <span class="k">case</span> <span class="n">datum</span>
     <span class="k">when</span> <span class="mi">0</span> <span class="k">then</span> <span class="no">Raise</span> <span class="no">ValidatorError</span><span class="p">,</span> <span class="s2">"zeros"</span><span class="p">,</span> <span class="mi">2014</span>
     <span class="k">when</span> <span class="s2">"password"</span>
       <span class="k">if</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">year</span> <span class="o">==</span> <span class="mi">2015</span>
         <span class="no">Raise</span> <span class="no">ValidatorError</span><span class="p">,</span> <span class="s2">"passwords"</span><span class="p">,</span> <span class="mi">2015</span>
       <span class="k">else</span>
         <span class="kp">true</span>
       <span class="k">end</span>
     <span class="k">when</span> <span class="sr">/SELECT \* FROM .+;/i</span>
       <span class="k">raise</span> <span class="no">ValidatorError</span><span class="p">,</span> <span class="s2">"cheating is not allowed"</span>
     <span class="k">else</span>
       <span class="kp">true</span>
     <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">e2mmap</code> does not restrict you to one message. The SQL query example shows that
you still can use plain old <code class="language-plaintext highlighter-rouge">raise</code> with the exception defined via <code class="language-plaintext highlighter-rouge">e2mmap</code> and
pass an arbitrary message.</p>

<h2 id="more-features">More features</h2>

<p>If you prefer to use <code class="language-plaintext highlighter-rouge">fail</code> instead of <code class="language-plaintext highlighter-rouge">raise</code>, <code class="language-plaintext highlighter-rouge">e2mmap</code> includes an alias for
<code class="language-plaintext highlighter-rouge">Raise</code>, which is called <code class="language-plaintext highlighter-rouge">Fail</code>. You can also use <code class="language-plaintext highlighter-rouge">fail</code> (<code class="language-plaintext highlighter-rouge">e2mmap</code> overrides the
default <code class="language-plaintext highlighter-rouge">fail</code>, so I do not recommend to use it in order to avoid confusion).</p>

<p>If you want to use a predefined message for an existing exception, you can use
the <code class="language-plaintext highlighter-rouge">def_e2message</code> method (instead of <code class="language-plaintext highlighter-rouge">def_exception</code>).</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'e2mmap'</span>

<span class="k">class</span> <span class="nc">Validator</span>
  <span class="kp">extend</span> <span class="no">Exception2MessageMapper</span>
  <span class="n">def_e2message</span> <span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">"sorry, wrong argument"</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">testRaise</span>
    <span class="no">Raise</span> <span class="no">ArgumentError</span>
    <span class="c1"># or Fail ArgumentError</span>
    <span class="c1"># or fail ArgumentError (not recommended)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">Validator</span><span class="p">.</span><span class="nf">testRaise</span> <span class="c1">#=&gt; ArgumentError: "sorry, wrong argument"</span>
</code></pre></div></div>

<p>Where does Ruby use <code class="language-plaintext highlighter-rouge">e2mmap</code> internally? Well, for example, IRB heavily uses it.
Other noticeable parts of Ruby’s stdlib that use <code class="language-plaintext highlighter-rouge">e2mmap</code> are <a href="https://github.com/ruby/ruby/blob/969057c95a4d8c26cf58dd99dff3dbface11f1cd/lib/matrix.rb#L16-L25"><code class="language-plaintext highlighter-rouge">Matrix</code></a>
and <a href="https://github.com/ruby/ruby/blob/d371e3583e3b1e0692f92343017b62d2628190ff/lib/shell/error.rb"><code class="language-plaintext highlighter-rouge">Shell</code></a>.</p>

<h2 id="conclusion">Conclusion</h2>

<p>I’ve never used this library myself (and never seen it being used in open source
projects), and I didn’t find <em>any</em> mentions of this library on the internet.
Hence, someone had to write about it. For additional reference you can <a href="https://github.com/ruby/ruby/blob/trunk/lib/e2mmap.rb">read the
source code of the library</a>. Also, this is probably the last Ruby article
of 2014.</p>

<p>Happy New Year!</p>


  </div>
</article>

<hr>

<div>
  
    <div>
      Next: <a href="/programming/ruby/2015/05/23/a-bit-of-bacon-lettuce-and-tomato.html" rel="next" title="A bit of bacon, lettuce and tomato">A bit of bacon, lettuce and tomato</a>
    </div>
  
  
    <div>
      Prev: <a href="/programming/javascript/2013/12/15/javascript-eval-tricks.html" rel="prev" title="JavaScript eval tricks">JavaScript eval tricks</a>
    </div>
  
</div>

    </main><footer>
  <hr>
  <small>
    <p><a href="/">Kyrylo Silin</a> — entrepreneur, software engineer, and web developer.</p>
    <p>
      Find me on:
      <a href="https://x.com/kyrylo" target="_blank">x</a>
      &middot;
      <a href="https://bsky.app/profile/kyrylo.org" target="_blank">bluesky</a>
      &middot;
      <a href="https://mastodon.social/@kyrylosilin" target="_blank">mastodon</a>
    </p>
    <p>
      <a href="/feed.xml">ATOM feed</a>
      |
      <a href="https://github.com/kyrylo/kyrylo.org">GitHub</a> (CC BY-NC-SA 4.0)
    </p>
    <p>Last modified: <time datetime="2024-06-10T09:55:11+03:00">June 10, 2024</time></p>
  </small>
</footer>
</body>

</html>
